(function(){"use strict";const V=self;console.log("VisualizerWorker: Worker script loaded");let l=null,f=null,m=null,d=null,u=null;const y=2048,W=new Float32Array(y);let p=0;V.onmessage=e=>{const{type:h}=e.data;switch(console.log("VisualizerWorker: Received message",h),h){case"INIT":{const r=e.data;console.log("VisualizerWorker: Initializing..."),l=r.canvas,m=r.config,f=l.getContext("2d"),console.log("VisualizerWorker: Canvas context created",!!f),u=r.port,console.log("VisualizerWorker: Port received"),u.onmessage=o=>{if(o.data.type==="AUDIO_DATA"){const v=o.data.data;for(let A=0;A<v.length;A++)W[p]=v[A],p=(p+1)%y}},M();break}case"AUDIO_DATA":break;case"RESIZE":{const r=e.data;l&&(l.width=r.width,l.height=r.height);break}case"DESTROY":{console.log("VisualizerWorker: Destroying"),d&&cancelAnimationFrame(d),u&&u.close(),l=null,f=null;break}}};function M(){d&&cancelAnimationFrame(d);const e=()=>{l&&f&&m&&R(f,l.width,l.height),d=requestAnimationFrame(e)};e()}let g=[];function R(e,h,r){if(e.clearRect(0,0,h,r),!m)return;const{barCount:o,gap:v,smoothingTimeConstant:A,dpr:k=1}=m;g.length!==o&&(g=new Array(o).fill(0));const w=4096,_=new Float32Array(w);for(let t=0;t<w;t++){const n=(p-w+t+y)%y;_[t]=W[n]}const z=Math.floor(w/o);let a=new Array(o).fill(0);for(let t=0;t<o;t++){let n=0;const i=t*z;for(let s=0;s<z&&!(i+s>=_.length);s++){const c=Math.abs(_[i+s]||0);c>n&&(n=c)}a[t]=n}a.reverse();const I=new Array(o).fill(0);for(let t=0;t<o;t++)if(t<3||t>=o-3)I[t]=a[t];else{const n=a[t-3],i=a[t-2],s=a[t-1],c=a[t],x=a[t+1],C=a[t+2],E=a[t+3],S=(-2*n+3*i+6*s+7*c+6*x+3*C-2*E)/21;I[t]=Math.max(0,S)}a=I;const D=r/k,F=h/k;e.save(),e.scale(k,k);for(let t=0;t<o;t++)g[t]+=(a[t]-g[t])*.15;e.fillStyle="#ffffff";const b=Math.max(1,F/o-1),T=Math.max(.5,F/o-b);for(let t=0;t<o;t++){let n=g[t];n>1&&(n=1);const i=t*(b+T),s=Math.max(2,n*D),c=D-s;e.beginPath(),e.roundRect(i,c,b,s,b/2),e.fill()}e.restore()}})();
